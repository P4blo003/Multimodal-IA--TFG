
# Obtiene el binario de Ollama.
echo -e "INFO\tDescargando binario de Ollama ..."
VERSION=$(curl -s https://api.github.com/repos/ollama/ollama/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")') > /dev/null 2>&1 || exit 1
curl -LO "https://github.com/ollama/ollama/releases/download/${VERSION}/ollama-linux-amd64.tgz" > /dev/null 2>&1 || exit 1
tar -xzf ollama-linux-amd64.tgz -C "$TEMP_DIR/app/third-party/ollama/bin/ollama"
rm ollama-linux-amd64.tgz
echo -e "OK\tBinario descargado."

# Clona el repositorio con sparse checkout.
echo -e "INFO\tClonando directorio de GitHub [$GIT_URL] ..."
git clone "$GIT_URL" "$TEMP_DIR" > /dev/null 2>&1 || exit 1
echo -e "OK\tDirectorio clonado."


# Copia las carpetas seleccionadas al directorio base.
for folder in "${FOLDERS[@]}"; do
    # Copia el directorio.
    cp -r "$folder" "$HOME/$BASE_DIR" || exit 1
    echo -e "OK\tCarpeta [$folder] creada en [$HOME/$BASE_DIR]"
done

# Limpia el directorio temporal.
cd "$HOME/$BASE_DIR" || exit 1
rm -rf "$TEMP_DIR"

# Genera las demás carpetas.
mkdir "bin" || exit 1
mkdir "bin/ollama" || exit 1
mkdir "data" || exit 1
mkdir "data/persistence" || exit 1
mkdir "data/raw" || exit 1
mkdir "logs" || exit 1
mkdir "resources" || exit 1

# Genera el entorno de ejecución del servidor.
python3 -m venv venv || exit 1
source venv/bin/activate || exit 1
echo -e "INFO\tInstalando librerías Python desde [dependencies/python_3.12.3/requirements.txt] ..."
pip install -r "dependencies/python_3.12.3/requirements.txt" > /dev/null 2>&1 || exit 1
echo -e "OK\tLibrerías instaladas."
deactivate

# Imprime información.
echo -e "OK\tServidor preparado para la ejecución."